---
title: "05_AUC_indexes"
author: "Pablo Navarro Carpio"
date: "2024-08-14"
output: html_document
---

# 1. Importar librerías y datos

```{r Importar librerías}
library(pROC)
library(purrr)
library(dplyr)
library(forcats)
library(tibble)
library(ROCpAI)
library(ROCnGO)
```

Para esta sección necesitaremos el conjunto de datos generado en la anterior sesión. El conjunto de datos contiene los niveles de diversos genes expresados en células luminales de próstata de pacientes con cancer.

```{r Importar datos}
roc_data <- readRDS("./rds_objects/04_filtered_tcga_data.rds")
```

# 2. AUCs

## 2.1. Introducción

En la literatura, 2 de las aproximaciones estadísticas más usadas para evaluar y comparar el rendimiento de una función o clasificador binario han sido las curvas $ROC$ (Característica Operativa del Receptor) y el área bajo dichas curvas ($AUC$).

El principal objetivo de un clasificador binario es discrimar instancias con una condición de interés de aquellas que no lo posean. Su precisión viene determianada por 2 métricas: su sensibilidad y su especificidad o la tasa verdaderos positivos ($TPR = Sensitivity$) y la tasa de falsos positivos ($FPR = 1 - Specificity$).

Cuando se trabaja con marcadores continuos, estos pueden ser dicotomizados en instancias positivas y negativas seleccionando una de las puntuaciones del marcador como un punto de corte, o umbral de decisión. Las curva $ROC$ representa los valores de $TPR$ y $FPR$ para cada uno de los umbrales de decisión de un marcador. Dado que estos puntos se calculan para todo un rango de umbrales, el $AUC$ actúa como una métrica global, mostrando los intercambios entre ambos parámetros de la curva, la ganancia o perdida de una métrica frente a otra.

## 2.2. Cálculo de AUCs para diagnóstico

Una vez se ha comprendido la teoría, podemos proceder a realizar los cálculos. Para ello utilizaremos la función `pROC::auc`, que calcula dicho parámetro utilizando una la variable para hacer la predicción (`predictor`) y una variable que contenga la respuesta a dicha predicción (`response`).

La función requiere que la respuesta sea un `factor` de valores `0` y `1`, que indica los casos con la condición de estudio y sin ella, respectivamente. En nuesto conjunto de datos, estos valores se corresponden con el caso opuesto, por lo que en primer lugar reorganizaremos estos valores.

```{r Reorganización del factor}
roc_data$disease <- fct_relevel(roc_data$disease, c("0", "1"))
```

Dado que en nuestro caso, buscaremos repetir el proceso para cada una de las variables utilizaremos la función `purrr::map_dbl`.

```{r Cálculo de AUCs para diagnóstico}
diagnostic_dataset <- roc_data %>% select(
    -c("sample", "gleason_score", "malignancy", "disease", "prognostic")
    )

auc_diagnostic <- map_dbl(
    diagnostic_dataset,
    auc,
    response = roc_data$disease,
    direction = "<",
    quiet = TRUE,
    .progress = TRUE
)
```

La función iterará sobre las columnas de los predictores y aplicará la función sobre cada uno de ellos. Como en este caso, buscaremos comprobar su validez como marcadores de diagnóstico, seleccionaremos la variable `disease` como la variable de respuesta.

## 2.3. Cálculo de AUCs para pronóstico

De forma similar a la anterior sección, podemos calcular que marcadores será mejores predictores con respecto a establecer un pronóstico para la enfermedad.

Esta sección requerirá de un filtrado previo, puesto que nuestro conjunto de datos contiene entradas de tanto tejidos sanos como enfermos, y para pronóstico, solo nos interesarán aquellos con la enfermedad. Para ello filtraremos los casos en los que se presenta la enfermedad y como estabamos trabajando con factores eliminaremos aquellos que no se utilizan (`Normal`).

```{r Filtrado de casos enfermos}
disease <- roc_data %>% filter(disease == 1)
disease[["prognostic"]] <- fct_drop(disease[["prognostic"]])
disease[["prognostic"]] <- fct_relevel(disease[["prognostic"]], c("0", "1"))
```

Una vez realizado el filtrado, podemos realizar el mismo procedimiento.

```{r Cálculo de AUCs para pronóstico}
prognostic_dataset <- disease %>% select(
    -c("sample", "gleason_score", "malignancy", "disease", "prognostic")
    )

auc_prognostic <- map_dbl(
    prognostic_dataset,
    auc,
    response = disease$prognostic,
    direction = "<",
    quiet = TRUE,
    .progress = TRUE
)
```

# 3. pAUC

## 3.1. Introducción

En ciertos contextos el estudio de la curva ROC en su totalidad no es de interés. En aplicaciones médicas y en otros campos, suelen seleccionarse ciertos rangos de la curva debido al interés por unos valores concretos de $TPR$ o $FPR$.

Por ejemplo en un contexto de diagnóstico, un marcador con un bajo $FPR$ (alta especifidad) es relevante a la hora de confirmar la presencia de una condición ("rule in"), dado que es muy improbable que se de un falso positivo. Mientras que un marcador con un alto $TPR$ (alta sensibilidad) es relevante para descartar la presencia de una condición ("rule out"), dado que es muy improbable que se de un falso negativo.

En estas situaciones el area parcial de la curva ROC ($pAUC$) atrae mucha más atención, ya que esta métrica sintetiza la información en la región de interés en lugar de en toda la curva.

## 3.2. Cálculo de pAUCs en regiones de alta especificidad

Explicada la importancia de trabajar en regiones concretas, podemos transladar la explicación a nuestro caso.

Un [diagnóstico temprano del cáncer de próstata](https://academic.oup.com/biostatistics/article/12/2/369/279985) es de gran importancia. En esta situación el pronóstico de un paciente puede mejorar en gran medida.

Sin embargo, el tratamiento para estas enfermedades es agresivo y debe considerarse. En este caso diagnósticar a un paciente con la enfermedad cuando no la tiene, puede ser un caso muy grave. Dada la situación es conveniente reducir estos casos, es decir el número de falsos positivos, por lo que requeriremos de una alta especificidad.

Para trabajar en condiciones de alta especificidad, seleccionaremos arbitrariamente rangos de $TPR$ contenidos en un intervalo de $(0.9,1)$. Para realizar estos cálculos utilizaremos de nuevo la función `pROC::auc` esta vez indicando que se limite a la especificidad (`partial.auc.focus = "spec"`) y sobre un rango concreto (`partial.auc = c(0.9, 1)`).

```{r Cálculo de pAUC en especificidad para diagnóstico}
pauc_sp_diagnostic <- map_dbl(
    diagnostic_dataset,
    auc,
    partial.auc = c(0.9, 1),
    partial.auc.focus = "spec",
    response = roc_data$disease,
    direction = "<",
    quiet = T,
    .progress = T
)
```

De forma similar, el pronóstico determinado para un paciente es relevante a la hora de seleccionar un tratamiento más o menos agresivo. Podríamos pensar de forma similar al escenario del caso de diagnóstico, un falso positivo puede tener consecuencias graves. Por ello consideraremos también condiciones de alta especificidad para la determinación de un pronóstico.

```{r Cálculo de pAUC en especificidad para pronóstico}
pauc_sp_prognostic <- map_dbl(
    prognostic_dataset,
    auc,
    partial.auc = c(0.9, 1),
    partial.auc.focus = "spec",
    response = disease$prognostic,
    direction = "<",
    quiet = T,
    .progress = T
)
```

## 3.3. Cálculo de pAUCs en regiones de alta sensibilidad

De forma similar al caso anterior podemos trasladar el caso de estudio a condiciones de alta sensibilidad. Escenarios donde se require una alta sensibilidad vienen dados normalmente por enfermedades que son fatales si no es tratan. Cometer un falso negativo puede implicar la muerte del paciente.

Hacer un mal pronóstico del paciente puede suponer graves consecuencias, por lo que a la hora de realizarlo puede ser importante considerar una alta sensibilidad. De modo que para calcular los índices, simplemente realizaremos el procedimiento anterior indicando que utilizaremos la sensibilidad (`partial.auc.focus = "sens"`).

```{r Cálculo de pAUC en sensibilidad para pronóstico}
pauc_sn_prognostic <- map_dbl(
    prognostic_dataset,
    auc,
    partial.auc = c(0.9, 1),
    partial.auc.focus = "sens",
    response = disease$prognostic,
    direction = "<",
    quiet = T,
    .progress = T
)
```

Finalmente y aunque quizá menos interesante desde el punto de vista clínico, pero también podríamos considerar relevante un contexto de alta sensibilidad para el diagnóstico de la enfermedad. Como hemos explicado antes, un diagnóstico temprano puede ser relevante en relación a evitar la muerte del paciente, por ello también podría llegar a considerarse este índice.

```{r Cálculo de pAUC en sensibilidad para diagnóstico}
pauc_sn_diagnostic <- map_dbl(
    diagnostic_dataset,
    auc,
    partial.auc = c(0.9, 1),
    partial.auc.focus = "sens",
    response = roc_data$disease,
    direction = "<",
    quiet = T,
    .progress = T
)
```

# 4. Índices derivados de pAUC

## 4.1. Problemas del pAUC

Aunque el $pAUC$ puede ser útil para trabajar en regiones de ínteres en la curva $ROC$ no está libre de fallas.

Este índice ha sido cuestionado por la falta de interpretabilidad, ya que algunos marcadores que puedan presentar altos valores para $AUC$ e incluso que rinden bien en las zonas seleccionadas, presentan valores de $pAUC$ muy ceracnos a 0.

Podemos comprobarlo con, por ejemplo, los 10 valores más altos de $AUC$ en marcadores de diagnóstico trabajando con alta especificidad.

```{r Comparación entre AUCs y pAUCs}
enframe(auc_diagnostic) %>%
    arrange(desc(value)) %>%
    left_join(
        enframe(pauc_sp_diagnostic),
        join_by(name == name)
    ) %>%
    dplyr::rename(
        auc = value.x,
        pauc = value.y
    ) %>%
    .[0:10,]
```

Como podemos observar, los valores obtenidos para $pAUC$ no superan el $0.5$; valor límite en el $AUC$ con el que consideraríamos que un clasificador rinde igual que un clasificador completamente aleatorio.

Además de por su interpretabilidad, la métrica presenta problemas cuando dos marcadores presentan valores iguales para el $pAUC$ pero sus curvas $ROC$ se cruzan, [imposibilitando el decidir cual de los 2 clasificadores rinde mejor](https://onlinelibrary.wiley.com/doi/full/10.1002/bimj.201400023). Este fenómeno se comprobará más adelante.

Para lidiar con estos problemas se han desarrollado diferentes transformaciones en los diversos índices, tanto en especificidad como en sensibilidad.

## 4.2. Índices para la especificidad

### 4.2.1. SpAUC

Una de las primeras transformaciones [propuestas por McClish](https://journals.sagepub.com/doi/10.1177/0272989X8900900307), es el área parcial bajo curva estandarizada ($SpAUC$).

Esta transformación trabaja con sobre un rango concreto de especificidad $(FPR_1, FPR_2)$, donde los límites superior e inferior para el $pAUC$ se escalan a los valores en el intervalo $(0.5, 1)$, haciendo que la métrica sea más interpretable. A pesar de ello, la métrica todavía presenta algunas desventajas.

El límite superior para el área que engloba el $pAUC$, esta definida por el rectángulo formado por los puntos: $(FPR_1, 0), (FPR_2, 0), (FPR_1, 1)$ y $(FPR_2, 1)$. Mientras que el límite inferior está definido por el trapecio con puntos: $(FPR_1, 0), (FPR_2, 0), (FPR_1, FPR_1)$ y $(FPR_2, FPR_2)$. Este será el trapecio que coincide con la diagonal de la curva. Si calculamos las áreas de los límites, el área $(A)$ que puede tomar el $pAUC$ está definida de la siguiente forma:

$$ 
\dfrac{1}{2}(FPR_2 - FPR_1)(FPR_2 + FPR_1) \le A \le FPR_2 - FPR_1
$$ Realizando la siguiente tranformación:

$$
\dfrac{1}{2}\left[1 + \dfrac{A - \text{min}}{\text{max} - \text{min}} \right]
$$ El índice toma un valor de $1$ cuando $A = \text{max}$ y un valor de $0.5$ cuando $A = \text{min}$, permitiendo ver el $pAUC$ de forma escalada al área total.

El problema que presenta la métrica, es que asume el mismo límite inferior para todas las curvas. En la práctica es común trabajar con curvas que atraviesen la diagonal, por lo que el límite inferior no está bien definido. Además, aunque resuelve el problema de facilitar la interpretación, no solventa el problema de 2 curvas con igual $pAUC$ que se cruzan.

Conociendo sus ventajas y desventajas, calcularemos el índice para contrastarlo con otros métodos. Para ello utilizaremos también la función `pROC::auc` indicando el argumento `partial.auc.correct = TRUE` para que aplique la corrección descrita por McClish. Además indicaremos `allow.invalid.partial.auc.correct = FALSE`, de esta forma la función no calculará el índice (aunque sea posible) si la curva está descrita por debajo del area mínima, puesto que el límite inferior no está bien definido, en su lugar devolverá un `NA`.

```{r Cálculo de SpAUC para diagnóstico, warning=FALSE}
spauc_sp_diagnostic <- map_dbl(
    diagnostic_dataset,
    auc,
    partial.auc = c(0.9, 1),
    partial.auc.focus = "spec",
    partial.auc.correct = TRUE,
    allow.invalid.partial.auc.correct = FALSE,
    response = roc_data$disease,
    direction = "<",
    quiet = TRUE,
    .progress = TRUE
)
```

```{r Cálculo de SpAUC para pronóstico, warning=FALSE}
spauc_sp_prognostic<- map_dbl(
    prognostic_dataset,
    auc,
    partial.auc = c(0.9, 1),
    partial.auc.focus = "spec",
    partial.auc.correct = TRUE,
    allow.invalid.partial.auc.correct = FALSE,
    response = disease$prognostic,
    direction = "<",
    quiet = TRUE,
    .progress = TRUE
)
```

### 4.2.2. TpAUC

Para solventar los problemas que el $SpAUC$ todavía presenta, [Vivo et al. han propuesto](https://link.springer.com/article/10.1007/s11634-017-0295-9) un índice alternativo para rangos especificidades concretos, el "tighter partial area index" $TpAUC$. Este nuevo índice, encuentra nuevos límites todavía más ajustados y teniendo en cuenta la forma que puede adoptar la curva $ROC$, es decir, siendo compatible con curvas que pasan por debajo de la diagonal o son inadecuadas.

Los límites iniciales propuestos por este índice parten de los establecidos por el $SpAUC$:

$$
\dfrac{1}{2}(FPR_2 - FPR_1)(FPR_2 + FPR_1) \le A \le FPR_2 - FPR_1
$$

Sin embargo, Vivo et al. proponen que estos límites se pueden ajustar a las regiones del area parcial donde esté definida la curva. Es decir, ajustandose a los puntos de la curva presentes en la región de interes, donde $TPR_i = TPR(FPR_i)$ para $i = 1,2$. De esta forma los límites se ajustan a:

$$
TPR_1(FPR_2 - FPR_1) \le A \le TPR_2(FPR_2-FPR_1)
$$

Este índice inferior se ajusta incluso cuando las curvas son inadecuadas en el límite inferior. De esta forma, cuando las curvas son adecuadas y no presentan ganchos, la siguiente expresión puede utilizarse:

$$
\text{max}\left\{TPR_1(FPR_2 - FPR_1), \dfrac{1}{2}(FPR_2 - FPR_1)(FPR_2 + FPR_1)\right\} \le A \le TPR_2(FPR_2-FPR_1)
$$

Finalmente, se debe considerar que las curvas $ROC$ normalmente son concavas, salvando la presencia de irregularidades (e.g. ganchos). Una curva $ROC$ concava, presenta un ratio de probabilidad positivo ($PLR(t) = ROC(t)/t$) decreciente. De esta forma el $PLR$ alcaza valores mínimos en el extremo superior de la curva.

Trasladado a este caso, si se puede asegurar que la curva se mantiene concava en la región de interés, es decir $PLR$ alcanza su mínimo valor en $FPR_2$ un límite inferior más ajustado se puede determinar, correspondiéndose al trapecio con puntos: $(FPR_1,0), (FPR_2, 0), (FPR_1, TPR_2)$ y $(FPR_2, TPR_2)$. Desarrollando esta área obtenemos:

$$
\dfrac{1}{2}(TPR_1+TPR_2)(FPR_2-FPR_1) \le A \le TPR_2(FPR_2-FPR_1)
$$

Conociendo los límites inferior y superior, y usándolos según las condiciones descritas, aplicando la transformación descrita por McClish para encapsular los valores entre $(0.5,1)$:

$$
\dfrac{1}{2}\left[1 + \dfrac{A - \text{min}}{\text{max} - \text{min}} \right]
$$

Se obtiene finalmente el $TpAUC$.

De forma similar, procederemos a calcularlo para contrastarlo con las demás métricas. El algoritmo para el cálculo de este índice está implementado en el paquete `ROCpAI` de [Bioconductor](https://www.bioconductor.org/packages/release/bioc/html/ROCpAI.html) con la función `tpAUC`. El paquete además incluye funciones para el cálculo de sus estabilidades, aunque para este caso nos bastará con la función principal.

La función utiliza como entrada un dataset donde la primera columna se corresponda con la respuesta y las siguientes los predictores.

```{r Cálculo de TpAUC para diagnóstico}
tpauc_sp_diagnostic_assay <- tpAUC(
    dataset = diagnostic_dataset %>% mutate(
        disease = roc_data$disease,
        .before = 1
    ),
    low.value = 0,
    up.value = 0.1,
    plot = FALSE
)
```

```{r Cálculo de TpAUC para pronóstico}
tpauc_sp_prognostic_assay <- tpAUC(
    dataset = prognostic_dataset %>% mutate(
        prognostic = disease$prognostic,
        .before = 1
    ),
    low.value = 0,
    up.value = 0.1,
    plot = FALSE
)
```

Dado que la salida de la función es un objeto con diversas métricas, utilizaremos la función `assay` para extraer los $SpAUC$ almacenados en en `St_pAUC`. Finalmente nombraremos cada uno de los valores con su respectivo identificador.

```{r Transformación en vector}
tpauc_sp_diagnostic <- as.numeric(assay(tpauc_sp_diagnostic_assay)$St_pAUC)
tpauc_sp_prognostic <- as.numeric(assay(tpauc_sp_prognostic_assay)$St_pAUC)

names(tpauc_sp_diagnostic) <- colnames(diagnostic_dataset)
names(tpauc_sp_prognostic) <- colnames(prognostic_dataset)
```

## 4.3. Índices para la sensibilidad

### 4.3.1. NpAUC

Uno de los primeros índices enfocados a trabajar en regiones de alta sensibilidad, es el [propuesto por Jiang et al.](https://sci-hub.se/https://doi.org/10.1148/radiology.201.3.8939225), el índice del area parcial normalizado ($NpAUC$). Este índices es conceptualmente similar a $SpAUC$. Teniendo en cuenta que para este caso $TPR_2 = 1$ y $TPR_1 = TPR_0$ y $TPR_1 < TPR_2$ se definen los límites superiores e inferiores, dados por:

-   El rectángulo de puntos $(1,1), (1, TPR_0), (0, 1)$ y $(0, TPR_0)$, es decir de longitud $1$ y altura dada por la banda $1 - TPR_0$.
-   El triángulo de puntos $(TPR_0, TPR_0), (1, TPR_0)$ y $(1,1)$.

Que de forma desarrollada, quedaría de la siguiente forma:

$$
\dfrac{1}{2}(1 - TPR_0)^2 \le A \le 1 - TPR_0
$$

A continuación, para llevar a cabo la normalización simplemente se divide cada término entre $1-TPR_0$ que se corresponde, como hemos explicado antes, con el área del rectángulo superior al $pAUC$.

$$
\dfrac{1}{2}(1-TPR_0) \le \dfrac{A}{1 - TPR_0} \le 1
$$

De esta forma, la métrica propuesta sería la siguiente:

$$
A' = \dfrac{A}{1 - TPR_0}
$$

Esta transformación permite que la métrica se interprete como el valor promedio de la especificidad para todos los valores de sensibilidad por encima de $TPR_0$.

A pesar de su utilidad a la hora de producir valores más interpretables y ser aplicable con algunas curvas inapropiadas, sigue presentando algunas desventajas. En primer lugar, el índices puede dar en ocasiones valores inferiores a $0.5$ y en segundo lugar, no es capaz de comparar de forma adecuada diversos clasificadores que puedan mostrar diferente forma en sus curvas $ROC$ y que tengan el mismo $pAUC$.

De forma similar a los otros índices procederemos a calcularlo para más tarde contrastarlo con el resto. Dado que el $NpAUC$ no se encuntra disponible en ningún paquete conocido, para facilitar su uso este índice ha sido incluido en un paquete propio, `ROCnGO`.

El paquete cuenta con la función `ROCnGO::np_auc`, que nos permite calcular el índice con un procedimiento similar a los casos anteriores.

```{r Cálculo de NpAUC para diagnóstico, warning=FALSE}
npauc_sn_diagnostic <- map_dbl(
    diagnostic_dataset,
    \(gene) {
        np_auc(
            predictor = gene,
            response = roc_data$disease,
            lower_tpr = 0.9
        )
    },
    .progress = TRUE
)
```

```{r Cálculo de NpAUC para pronóstico, warning=FALSE}
npauc_sn_prognostic <- map_dbl(
    prognostic_dataset,
    \(gene) {
        np_auc(
            predictor = gene,
            response = disease$prognostic,
            lower_tpr = 0.9
        )
    },
    .progress = TRUE
)
```

### 4.3.2. FpAUC

De forma similar al $TpAUC$ con respecto al $SpAUC$, en casos de especificidad, [Vivo et al.](https://www.mdpi.com/2227-7390/9/21/2826) propusieron un índice que pudiera solventar las desventajas del $NpAUC$. Este índice, denominado "fitted partial area index" ($FpAUC$), además de conservar las ventajas propuestas por el anterior, solventa los problemas que presentaba.

De esta forma el $FpAUC$ es capaz de:

1.  Ser interpretable como métrica de diagnóstico. Esto incluye ser igual a $AUC$ cuando $TPR_0 = 0$.
2.  Aplicarse a cualquier forma de la curva $ROC$, incluyendo las inadecuadas.
3.  Distinguir dos clasificadores con $pAUC$ iguales y que sus curvas $ROC$ se crucen.

Para calcular el $FpAUC$ en primer lugar, se deben definir nuevos límites para el $pAUC$ en condiciones de alta sensiblidad. En primer lugar, los límites iniciales son similares a los definidos en $NpAUC$, es decir:

$$
\dfrac{1}{2}(1 - TPR_0)^2 \le A \le 1 - TPR_0
$$

En primer lugar, un nuevo límite superior puede ser definido. Dado que una curva $ROC$ es una representación de las parejas de $TPR$ y $FPR$, de esta este límite puede limitarse a la región donde esté definidad la curva. Es decir, al rectángulo de puntos $(FPR_0, TPR_0), (FPR_0, 1), (1, TPR_0)$ y $(1,1)$, donde $FPR_0$ es el $FPR$ para el punto de la curva con $TPR_0$. De esta forma se obtiene:

$$
\dfrac{1}{2}(1 - TPR_0)^2 \le A \le (1-FPR_0)(1 - TPR_0)
$$

Como se ha explicado anteriormente, durante la sección del $TpAUC$, por definción las curvas $ROC$ son funciones monótonas no decrecientes. Esto no asegura, sin embargo, que sean concavas ya que en algunas ocasiones pueden pasar por debajo de la diagonal y mostrar rendimientos peores al de un predictor aleatorio.

La concavidad de la curva puede ser determinada por métricas como el ratio de probabilidad negativa ($NLR$). El $NLR$ se puede expresar matemáticamente de la siguiente forma $NLR = (1 - ROC(t))/(1 - t)$ para cada punto de la curva. Gráficamente, el $NLR$ representa la pendiente de la línea recta que pasa por un putno de la curva $ROC$ y el punto $(1,1)$. De esta forma, una curva concava presentará un $NLR$ decreciente.

De esta forma, si $NLR(t) \le NLR_0$ donde $NLR_0 = NLR(FPR_0)$ para $t \ge FPR_0$ o en otras palabras, si se asegura la concavidad en la región de alta sensibilidad, podemos definir un límite inferior más ajustado que viene dado por el triángulo de puntos $(FPR_0, TPR_0), (1, TPR_0)$ y $(1,1)$. De esta forma, podríamos ajustar los límites a:

$$
\dfrac{1}{2}(1 - FPR_0)(1 - TPR_0) \le A \le (1-FPR_0)(1 - TPR_0)
$$

Finalmente se debe considerar la posibilidad de que puedan aparecer ganchos en el extremo superior derecho de la región. En estas situaciones, incluso el límite inferior cuando no trabajamos con una curva $ROC$ concava, no se ajusta. De esta forma, se define que si existe $t \ge FPR_0$ que cumpla $NLR(t) > \text{max}\ \{1, NLR_0\}$, no podemos encontrar un límite inferior que se ajuste de forma que:

$$
0 \le A \le (1-FPR_0)(1 - TPR_0)
$$ Conociendo y considerando todas los casos posibles simplemente, aplicando la transformación descrita por McClish para que el índice quede contenido en un rango de $(0.5, 1)$

$$
\dfrac{1}{2}\left[1 + \dfrac{A - \text{min}}{\text{max} - \text{min}} \right]
$$

se obtiene el índice $FpAUC$.

De forma similar a los casos anteriores, calcularemos el índice para contrastarlo con el resto. Al igual que el $NpAUC$, el $FpAUC$ no se encuentra actualmente en ningún paquete conocido, por lo que también se ha incluido una función que permite calcularlo en el paquete `ROCnGO`.

Para calcular el índice para los predictores, se utilizará la función `ROCnGO::fp_auc`:

```{r Cálculo de FpAUC para diagnóstico, warning=FALSE}
fpauc_sn_diagnostic <- map_dbl(
    diagnostic_dataset,
    \(gene) {
        fp_auc(
            predictor = gene,
            response = roc_data$disease,
            lower_tpr = 0.9
        )
    },
    .progress = TRUE
)
```

```{r Cálculo de FpAUC para pronóstico, warning=FALSE}
fpauc_sn_prognostic <- map_dbl(
    prognostic_dataset,
    \(gene) {
        fp_auc(
            predictor = gene,
            response = disease$prognostic,
            lower_tpr = 0.9
        )
    },
    .progress = TRUE
)
```

# 5. Evaluación de índices

Hasta ahora se han calculado todos los índices para condiciones de alta sensibilidad y especificidad, enfocados a encontrar marcadores de diagnóstico así como de pronóstico. Sin embargo, como se ha ido explicando, cada índice presenta una serie de ventajas y desventajas.

De esta forma, para poder evaluar cual de los siguientes índices presenta un mejor rendimiento a la hora de identificar un marcador para estas condiones, necesitaremos comparar sus resultados.

## 5.1. Agrupar por condiciones

Para poder realizar comparaciones, deberemos agrupar las puntuaciones de los índices en las distintas condiciones.

```{r Índices de sensiblidad para diagnóstico}
indexes_sn_diagnostic <- tibble(
    identifier = names(auc_diagnostic),
    auc = auc_diagnostic,
    pauc = pauc_sn_diagnostic,
    npauc = npauc_sn_diagnostic,
    fpauc = fpauc_sn_diagnostic
)
```

```{r Índices de sensiblidad para pronóstico}
indexes_sn_prognostic <- tibble(
    identifier = names(auc_prognostic),
    auc = auc_prognostic,
    pauc = pauc_sn_prognostic,
    npauc = npauc_sn_prognostic,
    fpauc = fpauc_sn_prognostic
)
```

```{r Índices de especificidad para diagnóstico}
indexes_sp_diagnostic <- tibble(
    identifier = names(auc_diagnostic),
    auc = auc_diagnostic,
    pauc = pauc_sp_diagnostic,
    spauc = spauc_sp_diagnostic,
    tpauc = tpauc_sp_diagnostic
)
```

```{r Índices de especificidad para pronóstico}
indexes_sp_prognostic <- tibble(
    identifier = names(auc_prognostic),
    auc = auc_prognostic,
    pauc = pauc_sp_prognostic,
    spauc = spauc_sp_prognostic,
    tpauc = tpauc_sp_prognostic
)
```

## 5.2. Marcadores para diagnóstico

### 5.2.1. Métricas generales

Antes de proceder a analizar en detalle los distintos índices, se describiremos algunas métricas generales. Para ello, utilizaremos la función `ROCnGO::summarize_dataset`.

```{r Cálculo de métricas globales sensibilidad, warning=FALSE, eval=FALSE}
metrics_diagnostic_tpr <- summarize_dataset(
    diagnostic_dataset,
    predictors = NULL,
    response = roc_data$disease,
    ratio = "tpr",
    threshold = 0.9,
    .progress = TRUE
)
```

```{r Cálculo de métricas globales especificidad, eval=FALSE, warning=FALSE}
metrics_diagnostic_fpr <- summarize_dataset(
    diagnostic_dataset,
    predictors = NULL,
    response = roc_data$disease,
    ratio = "fpr",
    threshold = 0.1,
    .progress = TRUE
)
```

El conjuto de datos utilizado en condiciones de diagnóstico cuenta con la expresión de 2651 genes de 554 muestras extraídas de pacientes con cáncer de prostata, 52 de las cuales se corresponden con tejido sano y 502 con tejido cenceroso. Los genes seleccionados se corresponden con aquellos expresados diferencialmente en celulas luminales de próstata identificadas como cancerosas.

De los 2651 genes seleccionados, 1722 (64.95%) presentan un $AUC \ge 0.5$. En regiones de alta sensibilidad ($TPR \ge 0.9$), de este número 184 (10.68% y 6.94% del total) son completamente concavas, 148 (8.59% y 5.58% del total) presentan algun tipo de gancho sin atravesar la línea de azar (parcialmente adecuadas) y 1390 (80.72% y 54.43% del total) atraviesan en algún punto dicha línea.

En regiones de alta especificidad ($FPR \le 0.1$), de los predictores con un $AUC \ge 0.5$, 405 (23.51% y 15.27% del total) presentan curvas completamente concavas, 1032 (59.93% y 38.92% del total) presentan curvas parcialmente adecuadas y 285 (16.55% y 10.75% del total) contienen algún punto bajo la línea de azar.

### 5.2.2. Índices de sensbilidad: $NpAUC$ y $FpAUC$

Para evaluar en detalle los distintos índices, se exploraran algunas medidas de tendencia central.

```{r Tendencia central de los parámetros}
summary(indexes_sn_diagnostic)
```

Con las métricas es posible observar los rangos de valores que toman los distintos índices. El $pAUC$ toma valores inferiores a $0.5$, el $NpAUC$ toma valores tanto inferiores como superiores a dicho valor y finalmente el $FpAUC$, que solo presenta valores superiores.

En una primera instancia, se puede observar como el $pAUC$ se convierte en una métrica difícil de interpretar a simple vista, mientras que el $NpAUC$ y $FpAUC$ al tener límites defindos tienen una mejor interpretación.

Sin embargo si observamos de nuevo los rangos de valores, aunque tanto el $NpAUC$ y $FpAUC$ están comprendidos por un límite superior de $1$, no es el caso para su ímite inferior. Para comprender esta situacion utilizaremos como ejemplo el gen `ENSG00000169347`. Comprobando sus métricas con la función `ROCnGO::summarize_predictor`, para nuestro ratio ($TPR$) y umbral de interés ($0.9$), podemos ver que este clasificador se corresponse con el gen con mayor valor para $FpAUC$.

```{r Métricas de ENSG00000169347,warning=FALSE}
summarize_predictor(roc_data, ENSG00000169347, disease, "tpr", 0.9)
```

A pesar de tener el máximo valor para $FpAUC$, el clasificador presenta valores reducidos en la métrica global, $AUC$, y en las parciales, $pAUC$ y $NpAUC$. Para explicar estos resultados, representaremos la curva $ROC$ para este predictor con la función `ROCnGO::plot_curve_roc`.

```{r Predictor con límite inferior de NpAUC}
plot_roc_curve(roc_data, response = disease, predictor = ENSG00000169347) +
    add_chance_line() +
    add_tpr_threshold_line(0.9) +
    add_npauc_normalized_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000169347,
        threshold = 0.9
    )
```

Además de los puntos de la curva para el predictor, se ha representado el área para el límite inferior del $NpAUC$. Este límite se corresponde con la mitad del área de la banda $(TPR_0, 1)$, por ello cuando la curva cae por debajo de esta área podemos obtener valores inferiores a $0.5$, lo cual dificulta la interpretación en ciertos casos. Además de ello, la métrica se ve a afectada por la forma que disponga la curva.

Este no es el caso para el $FpAUC$, el cual establece su límite inferior en base a la forma de la curva.

```{r Predictor con límite inferior de NpAUC}
plot_partial_roc_curve(
    roc_data, 
    response = disease,
    predictor = ENSG00000169347,
    ratio = "tpr",
    threshold = 0.9
    ) +
    add_chance_line() +
    add_tpr_threshold_line(0.9) +
    add_fpauc_concave_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000169347,
        threshold = 0.9
    )
```

Ampliando la figura a la región de interés, observarmos como el límite inferior del $FpAUC$ se adapta a la región comprendida por la curva. Esto permite que el índice sea adecuado al margen del tipo de curva y presente valores mayores de $0.5$, haciéndolo más interpretable.

Esta información se puede contrastar además con el predictor `ENSG00000105707`, el predictor de mayor valor para $NpAUC$.

```{r Métricas de ENSG00000105707, warning=FALSE}
summarize_predictor(roc_data, ENSG00000105707, disease, "tpr", 0.9)
```

```{r Predictor ENSG00000105707 con límite inferior de NpAUC}
plot_roc_curve(roc_data, response = disease, predictor = ENSG00000105707) +
    add_chance_line() +
    add_tpr_threshold_line(0.9) +
    add_npauc_normalized_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000105707,
        threshold = 0.9
    )
```

```{r Predictor ENSG00000105707 con límite inferior de FpAUC}
plot_partial_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000105707,
        ratio = "tpr",
        threshold = 0.9
    ) +
    add_chance_line() +
    add_tpr_threshold_line(0.9)
```

En este caso, el área de la curva está en mayor parte contenida por encima del límite definido por $NpAUC$, lo cual confirma el razonamiento para tener un valor superior a $0.5$. El $FpAUC$ sin embargo no puede seleccionar ningún límite inferior puesto que, aunque pequeño, la curva presenta un gancho bajo la línea de azar en la parte superior.

A pesar de ello, dado que el índice también considera esta posibilidad, sigue presentando valores interpretables para una curva que casi engloba la totalidad de la región de interés. Lo cual refuerza que el $FpAUC$ presenta mejor interpretabilidad y es apto para cualquier tipo de curva.

Otra característica de interés de los índices es su capacidad para distinguir predictores con curvas $ROC$ que se cruzan y que presenten el mismo $pAUC$.

De todo el conjunto de datos, 633 predictores presentan un $pAUC$ idéntico a otro predictor, agrupados por $pAUC$ iguales en 246 grupos. Para evaluar el rendimiento de los índices utilizaremos los predictores `ENSG00000065361` y `ENSG00000130653`, aquellos que presentan el mayor valor de $pAUC$ en este subgrupo de predictores.

```{r Índices de alta sensbilidad para ENSG00000065361 y ENSG00000130653, warning=FALSE}

bind_rows(
    "ENSG00000065361" = summarize_predictor(
        roc_data, ENSG00000065361, disease, "tpr", 0.9
    ),
    "ENSG00000130653" = summarize_predictor(
        roc_data, ENSG00000130653, disease, "tpr", 0.9
    ),
    .id = "Identifier"
)

```

```{r Comparación de marcadores ENSG00000065361 y ENSG00000130653}

plot_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000065361
) +
    add_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000130653
    ) +
    add_chance_line() +
    add_threshold_line(0.9, "tpr")

```

Ambos predictores presentan un buen rendimiento global al tener un $AUC$ relativamente alto y sus curvas se cruzan en diversos puntos dentro de la región de alta sensibilidad. Dado que el $NpAUC$ simplemente realiza una normalización utilizando la banda de alta sensibilidad, la métrica no es capaz de seleccionar un predictor mejor, dando el mismo valor para ambos ($NpAUC = 0.2742875$).

Como hemos visto anteriormente el $FpAUC$ adapta sus límites a los puntos definidos por la curva en la región de interés, por ello es capaz de distinguir entre ambos predictores cual rinde mejor, el `ENSG00000065361`. Siguiendo este ejemplo, podemos deducir que el $FpAUC$ presenta una mayor capacidad de discriminación entre predictores con igual $pAUC$.

Contrastando las métricas de todo el conjunto de datos podemos observar esta capacidad de discriminación entre predictores.

```{r Número de desempates}
metrics_diagnostic_tpr$data %>%
    filter(pauc != 0) %>%
    group_by(pauc) %>%
    filter(n() > 1) %>%
    mutate(
        npauc_equal = all(
            map_lgl(np_auc, \(x) near(x, np_auc[[1]]))
        ),
        fpauc_equal = all(
            map_lgl(fp_auc, \(x) near(x, fp_auc[[1]]))
        )
    ) %>%
    summarize(
        npauc_equal = all(npauc_equal),
        fpauc_equal = all(fpauc_equal)
    ) %>%
    summarize(
        npauc_equal = sum(npauc_equal),
        fpauc_equal = sum(fpauc_equal)
    ) %>%
    mutate(
        npauc_distintct = 246 - npauc_equal,
        fpauc_distintct = 246 - fpauc_equal,
    ) %>%
    relocate(
        sort(names(.))
    )
```

De los 246 grupos formados, el $NpAUC$ no es capaz de desempatar en ninguno de ellos, a diferencia del $FpAUC$ que es capaz de seleccionar el mejor clasificador en 47 de los grupos. Estos calculos sobre todo el conjunto de datos refuerzan la afirmación de que el $FpAUC$ tiene una mejos rcapacidad de dsicriminación que el $NpAUC$.

### 5.2.3. Índices de especificidad: $SpAUC$ y $TpAUC$

De la misma forma que con los índices para la sensibilidad, en primer lugar exploraremos algunas métricas de tendencia central.

```{r Tendencia central de los parámetros}
summary(indexes_sp_diagnostic)
```

Con las métricas, de nuevo es posible observar como el $pAUC$ solo toma valores inferiores a $0.5$ lo cual dificulta su interpretabilidad, mientras que el $SpAUC$ y $TpAUC$ pueden tomar valores superiores.

De las métricas podemos descatar que el $TpAUC$ toma valores igual a 0 cuando teorícamente debería estar comprendido entre $0.5$ y $1$.

```{r TpAUCs igual a 0}
indexes_sp_diagnostic %>%
    filter(tpauc == 0)
```

Una exploración de los datos, nos muestra como estos valores para el $TpAUC$ se corresponden con valores de $pAUC$ iguales a $0$. Para comprobarlo de forma visual, representaremos algunos de ellos.

```{r Representación de predictores con pAUC = 0}
plot_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000169116
) + add_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000135378
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```

Como se observa en la figura, la curva de ambos predictores en la región de interés solo toma valores de $TPR = 0$, o en otras palabras no hay un area definida debajo de la curva. Si ampliamos la imagen, esto puede observarse con mayor claridad.

```{r Ampliación de predictores con pAUC = 0}
plot_partial_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000169116,
    ratio = "fpr",
    threshold = 0.1
) + add_partial_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000135378,
        ratio = "fpr",
        threshold = 0.1
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```

Habiendo comprobado el origen de estos valores atípicos, podemos recalcular las métricas filtrando los predictores con $pAUC = 0$ y comprobar que los valores del $TpAUC$ ahora sí que se encuentran limitados por abajo en $0.5$, de forma similar al $SpAUC$.

```{r Tendencia central de los parámetros}
summary(indexes_sp_diagnostic %>% filter(pauc != 0))
```

Dado que ambas métricas están contenidas entre valores de $0.5$ y $1$, la interpretabilidad de ambos índices es buena. Sin embargo, podemos observar que algunos valores para el $SpAUC$ se corresponden con valores de `NA`.

Como se ha explicado anteriormente, el $SpAUC$ tiene su límite definido con el trapecio de puntos $(FPR_1, 0), (FPR_2, 0), (FPR_1, FPR_1)$ y $(FPR_2, FPR_2)$, o en otras palabras, el que coincide con la línea del azar. El problema que presenta es que para curvas que esten definidas por debajo de dicha línea, este límite no se cumple, es por esta razón por la cual la función devuelve estos valores.

Podemos comprobarlo gráficamente con el predictor `ENSG00000181754`, un predictor que aun presentando una forma concava en la región de interés, pasa por debajo de la línea de azar.

```{r Métricas del predictor ENSG00000181754, warning=FALSE}
summarize_predictor(
    roc_data,
    ENSG00000181754,
    disease,
    "fpr",
    0.1
)
```

```{r Plot predictor ENSG00000181754, warning=FALSE}
plot_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000181754
) +
    add_spauc_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000181754,
        lower_threshold = 0,
        upper_threshold = 0.1
    ) +
    add_tpauc_concave_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000181754,
        lower_threshold = 0,
        upper_threshold = 0.1
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```

Como se puede observar en la figura, el límite inferior definido por el $SpAUC$ se encuentra por encima de la curva definida por el predictor. En comparativa, dado que el $TpAUC$ se ajusta a la región de la curva y a la forma de esta, podemos ver como en su caso la curva queda definida por encima del límite inferior.

Este ajuste se puede contrastar seleccionando otro predictor con una forma de curva distinta. Por ejemplo, podemos utilizar como ejemplo el predictor `ENSG00000111667`.

```{r Métricas del predictor ENSG00000111667, warning=FALSE}
summarize_predictor(
    roc_data,
    ENSG00000111667,
    disease,
    "fpr",
    0.1
)
```

```{r Plot predictor ENSG00000111667, warning=FALSE}
plot_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000111667
) +
    add_spauc_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000111667,
        lower_threshold = 0,
        upper_threshold = 0.1
    ) +
    add_tpauc_under_chance_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000111667,
        lower_threshold = 0,
        upper_threshold = 0.1
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```

Como se puede ver, el límite definido por el $TpAUC$ se ajusta a la curva y esta queda por encima del límite. En este caso se ajusta a $TPR = 0$, por lo que no hay un area mínima definida, es decir el límite inferior es $0$. Mientras que para el $SpAUC$, el límite definido no se adecua bien, con zonas que hacen que la curva pase por encima y otras por debajo.

Con estas observaciones, podemos deducir que cuando tratamos con curvas con una forma adecuada y que estén definidas tanto el $SpAUC$ y el $TpAUC$ son métricas interpretables. Ambas quedan comprendidas entre valores de $0.5$ y $1$.

Sin embargo, cuando no trabajamos en estas condiciones el $TpAUC$ se convierte en una métrica más adecuada, puesto que como se ha podido comprobar los límites que define se ajustan a la forma de la curva a diferencia del $NpAUC$, asegurando que los límites definidos se cumplan.

Una vez considerada la interpretabilidad de ambas métricas, podemos contrastar su capacidad de distinguir entre curvas con igual $pAUC$ y que se cruzan.

Del conjunto de datos, 374 predictores presentan un $pAUC$ igual a otro, agrupados en 174 grupos. Para evaluar el rendimiento de los índices utilizaremos los predictores `ENSG00000175336` y `ENSG00000169733`, aquellos que presentan el mayor valor de $pAUC$ en este subgrupo de predictores.

```{r Índices de alta especificidad para ENSG00000175336 y ENSG00000169733, warning=FALSE}
bind_rows(
    "ENSG00000175336 " = summarize_predictor(
        roc_data,
        ENSG00000175336,
        disease,
        "fpr",
        0.1
    ),
    "ENSG00000169733" = summarize_predictor(
        roc_data,
        ENSG00000169733,
        disease,
        "fpr",
        0.1
    ),
    .id = "Identifier"
)
```

```{r Comparación de marcadores ENSG00000175336 y ENSG00000169733}

plot_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000175336
) +
    add_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000169733
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")

```

Como se puede observar ambos predictores presentan un buen rendimiento en global, dado en su $AUC$. Por otra parte el $SpAUC$ para ambos predictores se mantiene igual ($SpAUC = 0.7238576$). Esto puede deberse a que ambos predictores presentan tanto los mismos límites superior e inferior para ambos predictores.

Por otra parte el $TpAUC$ adapta sus límites a los puntos definidos por la curva en la región de interés, tanto superior como inferior. Esto permite al índice ser capaz de identificar al predictor con mejor rendimiento, `ENSG00000169733`. 

Podemos contrastar esta capacidad de discriminación entre predictores con el resto del conjunto de datos:

```{r Número de desempates}
metrics_diagnostic_fpr$data %>%
    filter(pauc != 0) %>%
    group_by(pauc) %>%
    filter(n() > 1) %>%
    mutate(
        spauc_equal = all(
            map_lgl(sp_auc, \(x) near(x, sp_auc[[1]]))
        ),
        tpauc_equal = all(
            map_lgl(tp_auc, \(x) near(x, tp_auc[[1]]))
        )
    ) %>%
    summarize(
        spauc_equal = all(spauc_equal),
        tpauc_equal = all(tpauc_equal)
    ) %>%
    dplyr::count(spauc_equal, tpauc_equal)
```

De los 374 predictores, con $pAUC > 0$ e igual al menos a otro predictor, agrupados en 174 grupos según el valor de $pAUC$, observamos como el $SpAUC$ no es capaz de diferenciar un predictor de mayor rendimiento en ningún caso. Además de no ser capaz de identificar un mejor predictor, cabe matizar que este índice solamente toma valores en 95 de los grupos mientras que en 79 de ellos no se encuentra definido.

Por otro lado, el $TpAUC$ es capaz de distinguir un mejor predictor en 138 de los grupos, mientras que es incapaz de encontrar diferencias en 36 de ellos.

Observando estos valores para todo el conjunto de datos, refuerza la afirmación de que ambos índices son fácilmente interpretables, sin embargo también refuerzan el hecho de que el $SpAUC$ no es totalmente adecuado en la practica, puesto que no puede aplicarse a situaciones donde la curva pase por debajo de la línea del azar. Además y al margen de ello, el $SpAUC$ tiene una menor capacidad de discriminación entre predictores a diferencia del $TpAUC$, el cual ha sido capaz de indentificar en la mayoría de empates el mejor predictor.

## 5.3. Marcadores para pronóstico

### 5.3.1. Métricas generales

A continuación repetiremos los procedimientos previamente realizados, pero en esta ocasión aplicados a marcadores de pronóstico.

```{r Cálculo de métricas globales sensibilidad-pronostico, warning=FALSE}
metric_prognostic_tpr <- summarize_dataset(
    prognostic_dataset,
    predictors = NULL,
    response = disease$prognostic,
    ratio = "tpr",
    threshold = 0.9,
    .progress = TRUE
)
```

```{r Cálculo de métricas globales especificidad-pronostico, warning=FALSE}
metric_prognostic_fpr <- summarize_dataset(
    prognostic_dataset,
    predictors = NULL,
    response = disease$prognostic,
    ratio = "fpr",
    threshold = 0.1,
    .progress = TRUE
)
```

El conjunto de datos utilizado para condiciones de pronóstico cuenta con la expresión de 2651 genes de 502 muestras de tejido canceroso, provenientes de pacientes con la enfermedad. Al igual que el conjunto utilizado en condiciones de diagnóstico, los genes seleccionados se corresponde con aquellos expresados diferencialmente en células luminales de próstata identificadas como cancerosas.

De los genes seleccionados, 1015 (38.28 %) presentan un $AUC \ge 0.5$. En regiones de alta sensibilidad ($TPR \ge 0.9$), de este número 173 tienen una forma concava (17.04% y 6.54% del total), 296 (29.16% y 11.16% del total) presentan algún tipo de gancho sin llegar a atravesar la línea del azar (parcialmente adecuadas) y 546 (53.79% y 20.59% del total) atraviesan en algún punto dicha línea.

Para regiones de alta especificidad ($FPR \le 0.1$), de los predictores con un $AUC \ge 0.5$, 127 (12.51%, un 4.79% del total) presentan curvas cóncavas, 377 (37.14%, un 14.22% del total) curvas parcialmente adecuadas y 511 (50.34%, un 19.27% del total) contienen algún punto bajo la línea de azar

### 5.3.2. Índices de sensibilidad: $NpAUC$ y $FpAUC$

De forma similar al procedimiento en condiciones de diagnóstico, exploraremos algunas medidas de tendencia central.

```{r Tendencia central de los parámetros}
summary(metric_prognostic_tpr$data)
```
En este contexto podemos volver a observar como el $pAUC$ toma valores inferiores a $0.5$ y el $FpAUC$ superiores. La única diferencia destacable es que ahora el $NpAUC$ solamente toma valores inferiores a $0.5$.

Como se ha explicado previamente, esto puede deberse a que el límite inferior definido por el $NpAUC$. Al corresponderse con la mitad del área definida por la banda $(TPR_0, 1)$, cualquier curva que no esté contenida por encima puede dar valores inferiores a $0.5$. Para visualizarlo, escogeremos el predictor `ENSG00000185615`, que se corresponde con el mayor valor de $NpAUC$ en los datos.

```{r Métricas de ENSG00000185615, warning=FALSE}
summarize_predictor(
    prognostic_dataset %>% mutate(prognostic = disease$prognostic),
    ENSG00000185615,
    prognostic,
    "tpr",
    0.9
)
```
```{r Predictor con límite inferior de NpAUC}
plot_roc_curve(
    prognostic_dataset %>% mutate(prognostic = disease$prognostic),
    response = prognostic,
    predictor = ENSG00000185615
    ) +
    add_chance_line() +
    add_tpr_threshold_line(0.9) +
    add_fpauc_partially_proper_lower_bound(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000185615,
        threshold = 0.9
    ) +
    add_npauc_normalized_lower_bound(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000185615,
        threshold = 0.9
    ) 
```

Como se observa en la gráfica, efectivamente la curva se encuentra contenida por debajo del límite definido por el $NpAUC$, a diferencia del definido por el $FpAUC$ que se ajusta a la forma de la curva. Así, de nuevo, en el contexto de la búsqueda de marcadores de pronóstico en condiciones de alta sensibilidad, el $FpAUC$ presenta una mejor interpretabilidad.

Además de su interpretabilidad, podemos evaluar su capacidad de distinguir predictore con igual $pAUC$ y cuyas curvas se crucen en algún punto en la región de interés.

De todo el conjunto de datos, 241 predictores presentan un $pAUC$ idéntico a al menos otro, los cuales se han agrupado en 114 grupos según esta métrica. Para evaluar el rendimiento de los índices utilizaremos los predictores `ENSG00000272333` y `ENSG00000096070` los cuales presentan el mayor $pAUC$ entre los predictores.

```{r Índices de alta sensibilidad para ENSG00000272333 y ENSG00000096070, warning=FALSE}
bind_rows(
    "ENSG00000272333" = summarize_predictor(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        ENSG00000272333,
        prognostic,
        "tpr",
        0.9
    ),
    "ENSG00000096070" = summarize_predictor(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        ENSG00000096070,
        prognostic,
        "tpr",
        0.9
    ),
    .id = "Identifier"
)
```
```{r Comparación de marcadores ENSG00000272333 y ENSG00000096070, warning=FALSE}
plot_roc_curve(
    prognostic_dataset %>% mutate(prognostic = disease$prognostic),
    response = prognostic,
    predictor = ENSG00000272333
) +
    add_roc_curve(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000096070
    ) +
    add_chance_line() +
    add_threshold_line(0.9, "tpr")

```
En este caso, los predictores no presentan un buen rendimiento a nivel global, a diferencia de la región de interés. En esta región, ambas curvas se cruzan en varios de sus puntos y mientras el $NpAUC$ no es capaz de diferenciar cual engloba mayor área ($NpAUC = 0.13159748$), mientras que por otra parte el $FpAUC$ es capaz de identificar que el `ENSG00000096070` presenta una mayor área ($FpAUC = 0.8087762$) que el `ENSG00000272333` ($FpAUC = 0.7782804$).

De forma similar a las condiciones de diagnóstico, dado que $FpAUC$ adapta sus límites a los puntos definidos por la curva y su forma, es capaz de distinguir entre predictores de igual $pAUC$ cuyas curvas se cruzan. Esta capacidad se puede observar en todo el conjunto de datos.

```{r Número de desempates}
metric_prognostic_tpr$data %>%
    filter(pauc != 0) %>%
    group_by(pauc) %>%
    filter(n() > 1) %>%
    mutate(
        npauc_equal = all(
            map_lgl(np_auc, \(x) near(x, np_auc[[1]]))
        ),
        fpauc_equal = all(
            map_lgl(fp_auc, \(x) near(x, fp_auc[[1]]))
        )
    ) %>%
    summarize(
        npauc_equal = all(npauc_equal),
        fpauc_equal = all(fpauc_equal)
    ) %>%
    dplyr::count(npauc_equal, fpauc_equal)
```
De los 114 grupos con igual $pAUC$, el $FpAUC$ es capaz de desempatar en 38 de ellos, mientras que en su lugar el $NpAUC$ debido a como establece sus límites no es capaz de discriminar entre un mejor predictor de cada grupo.

### 5.3.3. Índices de espcecificidad: $SpAUC$ y $TpAUC$

Igual que en los casos anteriores, para realizar la evaluación de los índices exploraremos algunas métricas generales en primer lugar.

```{r Tendencia central de los parámetros}
summary(metric_prognostic_fpr$data)
```

De nuevo, el $pAUC$ solo toma valores inferiores a $0.5$ a diferencia del $SpAUC$ y del $TpAUC$, que toman valores superiores y por tanto siendo métricas más interpretables.

Como hemos visto anteriormente el $SpAUC$ toma valores `NA`, los cuales se corresponden para casos donde el límite inferior definido (el trapecio de puntos $(FPR_1, 0), (FPR_2, 0), (FPR_1, FPR_1)$ y $(FPR_2, FPR_2)$) no se cumple y la función devuelve este valor.

A diferencia del caso anterior, el $TpAUC$ no toma valores atípicos por debajo de $0.5$, lo cual se debe a que en este caso no tenemos ningún predictor con $pAUC = 0$.

Podemos contrastar la interpretabilidad de ambos índices utilizando arbitrariamente el predictor `ENSG00000110013`, que no presenta valor para el $SpAUC$ y uno relativamente alto para el $TpAUC$.

```{r Métricas del predictor ENSG00000110013, warning=FALSE}
summarize_predictor(
    prognostic_dataset %>% mutate(prognostic = disease$prognostic),
    ENSG00000110013,
    prognostic,
    "fpr",
    0.1
)
```

```{r Plot predictor ENSG00000196363, warning=FALSE}
plot_roc_curve(
    prognostic_dataset %>% mutate(prognostic = disease$prognostic),
    response = prognostic,
    predictor = ENSG00000110013
) +
    add_spauc_lower_bound(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000110013,
        lower_threshold = 0,
        upper_threshold = 0.1
    ) +
    add_tpauc_under_chance_lower_bound(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000110013,
        lower_threshold = 0,
        upper_threshold = 0.1
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```
Como puede observarse la curva se encuentra definida por debajo del límite delimitado por el $SpAUC$, lo cual coincide con el valor de `NA`, dado que no se puede calcular. Por otra parte, el $TpAUC$ define un límite que se ajusta a la forma de la curva (en este caso $0$, dado que $TPR = 0$) y por tanto es posible calcularlo.

De forma general, ambas métricas se comprenden entre valores de $0.5$ y $1$, lo cual permite que sean fácilmente interpretables. Aunque ambas métricas se puedan interpretar fácilmente, dado que el $SpAUC$ define unos límites que no se ajustan para ciertas curvas con determinadas formas lo cual imposibilita su aplicación, haciendo más idóneo el $TpAUC$ el cual se ajusta a la curva y se puede aplicar independientemente de ella.

Considerada la interpretabilidad de ambas métricas, ahora podemos contrastar la capacidad de distinguir entre curvas con igual $pAUC$ y que se cruzan.

Del conjunto de datos, 917 predictores presentan un $pAUC$ al menos igual a otro; los cuales se agrupan en 407 grupos distintos en función de su $pAUC$. Para contrastar su capacidad de discriminación, al igual que en los casos anteriores, utilizaremos los predictores `ENSG00000177943` y `ENSG00000136783`, los cuales se corresponden con aquellos de mayor valor para el $pAUC$ en este subgrupo.

```{r Índices de alta especificidad para ENSG00000177943 y ENSG00000136783, warning=FALSE}
bind_rows(
    "ENSG00000177943" = summarize_predictor(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        ENSG00000177943,
        prognostic,
        "fpr",
        0.1
    ),
    "ENSG00000136783" = summarize_predictor(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        ENSG00000136783,
        prognostic,
        "fpr",
        0.1
    ),
    .id = "Identifier"
)
```

```{r Comparación de marcadores ENSG00000177943 y ENSG00000136783, warning=FALSE}
plot_roc_curve(
         prognostic_dataset %>% mutate(prognostic = disease$prognostic),
         response = prognostic,
         predictor = ENSG00000177943
) + 
    add_roc_curve(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000136783
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```
Ambos predictores presentan un rendimiento ligeramente mejor que un clasificador aleatorio a nivel global, a diferencia de la región de interés, donde relativamente mejor. En este caso ambos predictores presentan un $SpAUC$ igual ($SpAUC = 0.5643124$). Lo cual se debe a que ambos presentan el mismo límite superior e inferior. 

Por otra parte el $TpAUC$ toma valores distintos para cada uno de los predictores, dado que ajusta sus limites a las zonas definidas por ambas curvas.

```{r Comparación de marcadores ENSG00000177943 y ENSG00000136783, warning=FALSE}
plot_partial_roc_curve(
         prognostic_dataset %>% mutate(prognostic = disease$prognostic),
         response = prognostic,
         predictor = ENSG00000177943,
         ratio = "fpr",
         threshold = 0.1
) + 
    add_partial_roc_curve(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000136783,
        ratio = "fpr",
        threshold = 0.1
    ) +
    add_tpauc_partially_proper_lower_bound(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000177943,
        upper_threshold = 0.1,
        lower_threshold = 0
    ) +
    add_tpauc_partially_proper_lower_bound(
        prognostic_dataset %>% mutate(prognostic = disease$prognostic),
        response = prognostic,
        predictor = ENSG00000136783,
        upper_threshold = 0.1,
        lower_threshold = 0
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```
Para este caso en particular, ambos predictores poseen el mismo límite inferior, sin embargo sus límite superiores serán distintos dado que ambas poseen un $TPR$ distinto, para el $FPR_2$. Así el $TpAUC$ toma valores diferentes para cada predictor, pudiendo establecer que el predictor `ENSG00000177943` ($TpAUC = 0.8111201$) rinde mejor que `ENSG00000136783` ($TpAUC = 0.7711047$).

Esta afirmación se puede contrastar en todo el conjunto de datos, es decir en todos los grupos:

```{r Número de desempates}
metric_prognostic_fpr$data %>%
    filter(pauc != 0) %>%
    group_by(pauc) %>%
    filter(n() > 1) %>%
    mutate(
        spauc_equal = all(
            map_lgl(sp_auc, \(x) near(x, sp_auc[[1]]))
        ),
        tpauc_equal = all(
            map_lgl(tp_auc, \(x) near(x, tp_auc[[1]]))
        )
    ) %>%
    summarize(
        spauc_equal = all(spauc_equal),
        tpauc_equal = all(tpauc_equal)
    ) %>%
    dplyr::count(spauc_equal, tpauc_equal)
```

De los 407 grupos de grupos formados, el $SpAUC$ no es capaz de diferenciar un marcador que rinda mejor en ninguno de ellos, es más, no es capaz de aplicarse debido a la forma de la curva en 194 de ellos.

Por otra parte el $TpAUC$ es capaz de diferenciar un mejor predictor en 323 grupos de los 407 totales. Este hecho refuerza que el $TpAUC$ es una mejor métrica a la hora de evaluar el rendimiento de un predictor, dado que es aplicable a cualquier tipo de curva y es capaz de discriminar entre predictores con igual $pAUC$, a diferencia del $SpAUC$.

# 6. Resultados

## 6.1. Rendimiento de métricas

Hasta ahora hemos comparado con diversos predictores el rendimiento de diversos índices escalados de $pAUC$ tanto en condiciones de alta sensibilidad y de alta especificidad. De forma general, se ha podido observar como los índices de alta especificidad y sensibilidad respectivamente, $SpAUC$ y $NpAUC$ presentan ciertas limitaciones que son solventadas por $TpAUC$ y $FpAUC$. En primer lugar ambas métricas presentan límites inferiores y superiores que o bien imposibilitan su aplicación, siendo el caso del $SpAUC$ en curvas por debajo de la línea del azar, o bien dificultando su interpretación, en el caso del $NpAUC$ cuando una curva no ocupa la mitad de su límite superior dando valores inferiores a $0.5$. En segundo lugar, estas métricas no son capaces de distinguir entre predictores que presenten un mismo $pAUC$ y se crucen en la región de estudio, siendo incapaces de seleccionar el predictor de mejor rendimiento.

Por otra parte, los índices $TpAUC$ y $FpAUC$ además de ser aplicables a cualquier curva independientemente de su forma, ser interpretables como métricas al comprender sus valores entre $0.5$ y $1$; son capaces de distinguir entre predictores que reportan $pAUC$ iguales y sus curvas se cruzan en la región de interés, cuestión que quedaba sin resolver hasta ahora.

## 6.2. Relevancia clínica

Aunque la solución de estas limitaciones permite calificar al $TpAUC$ y $FpAUC$ como mejores métricas, estas deben de seguir siendo capaces de encontrar marcadores clínicamente relevantes en los casos de estudio. El rendimiento de estos índices puede comprobarse con el conjunto de datos generado para diagnóstico y pronóstico de cáncer de prostata.

Desde la primera vez que fue descrito, el antígeno específico de prostata (PSA) ha sido utilizado en los planes de diagnóstico y tratamiento de pacientes con cáncer de próstata. Desde su aplicación, la mortalidad y el número de diagnósticos en estadíos avanzados de la enfermedad se ha reducido, sin embargo este biomarcador presenta [ciertas limitaciones](https://www.mdpi.com/1422-0067/23/22/14257). Aunque el PSA es específico del tejido, este puede presentarse en lesiones benignas, es decir generando falsos positivos; además a la hora de realizar una estratificación del riesgo de un paciente requiere de técnicas y métricas adicionales.

El nombre de PSA es utilizado en el ámbito clínico, en otros ámbitos es conocida como kallikrein related peptidase 3 (*KLK3*) una proteasa expresada en las células del tejido. Este marcador se encuentra entre los descritos en el conjunto de datos, con el identificador `ENSG00000142515`.

```{r Métricas KLK3 diagnóstico}
inner_join(
    metrics_diagnostic_tpr$data %>% filter(identifier == "ENSG00000142515") %>% select(-curve_shape),
    metrics_diagnostic_fpr$data %>% filter(identifier == "ENSG00000142515") %>% select(-curve_shape),
    join_by(identifier, auc),
    suffix = c("_sens", "_spec")
)
```
Además entre los datos también se pueden encontrar otros marcadores de diagnóstico: *AMACR* (`ENSG00000242110`) y *FOLH1* (`ENSG00000086205`), los cuales se pueden comparar con *KLK3*.

```{r Marcadores de diagnostico alternativos}
known_markers <- c(
    "ENSG00000242110",
    "ENSG00000086205",
    "ENSG00000142515"
)

metrics_diagnostic_fpr$data %>%
    filter(identifier %in% known_markers)
```

```{r Marcadores de diagnóstico}
plot_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000142515
) + 
    add_roc_curve(roc_data, response = disease, predictor = ENSG00000242110) + 
    add_roc_curve(roc_data, response = disease, predictor = ENSG00000086205) + 
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```

*KLK3* no presenta un buen rendimiento a nivel global, sin embargo, en la región de interés presenta un rendimiento algo mejor esto pone de manifiesto su uso hasta la fecha y relevancia clínica de regiones concretas de la curva. A pesar de ello, como se ha explicado previamente el *KLK3* presenta un gran número de falsos positivos lo cual explica que otros predictores como *FOLH1* y *AMACR* presentan mejores puntuaciones no solo a nivel global y sino también en la región de alta especificidad.

```{r Marcadores de diagnóstico en alta especificidad, warning=FALSE}
plot_partial_roc_curve(
    roc_data,
    response = disease,
    predictor = ENSG00000142515,
    ratio = "fpr",
    threshold = 0.1
) + 
    add_partial_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000242110,
        ratio = "fpr",
        threshold = 0.1
    ) + 
    add_partial_roc_curve(
        roc_data,
        response = disease,
        predictor = ENSG00000086205,
        ratio = "fpr",
        threshold = 0.1
    ) + 
    add_tpauc_concave_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000242110,
        upper_threshold = 0.1,
        lower_threshold = 0
    ) +
    add_tpauc_partially_proper_lower_bound(
        roc_data,
        response = disease,
        predictor = ENSG00000086205,
        upper_threshold = 0.1,
        lower_threshold = 0
    ) +
    add_chance_line() +
    add_threshold_line(0.1, "fpr")
```

Centrandonos en esta región, el $SpAUC$ califica a *AMACR* como el mejor de los predictores y al resto muy por debajo, a diferencia del $TpAUC$ que califica a *FOLH1* como el predictor de mayor rendimiento, pero a un nivel similar de *AMACR*.

Si contrastamos estos resultados, como se ha explicado, tanto el [*AMACR* ](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3794046/) como el *FOLH1* están sobrexpresados en pacientes con la enfermedad, pero actualmente el *FOLH1* presenta un mayor interés ya que además de un potencial uso a nivel de diagnóstico también lo presenta como [diana terpéutica](https://www.sciencedirect.com/science/article/pii/S2405456921001681). Esto refuerza la interpretación dada por el $TpAUC$ frente a los otros índices, donde tanto *AMACR* y el *FOLH1* presentan potencial como clasificadores, pero además clasifica a este último como ligeramente mejor que el primero.

Finalmente si seleccionamos alguno de los primeros marcadores identificados por el $TpAUC$, puede observarse que se encuentran relacionados con la enfermedad, como es el caso de *ESRP2* (`ENSG00000103067`) al cual estudios recientes también lo describen como tener un papel relevante en el [desarrollo de la enfermedad](https://www.nature.com/articles/s41388-023-02838-9).

```{r Gen ESRP2}
metrics_diagnostic_fpr$data %>% filter(identifier == "ENSG00000103067") %>% select(-curve_shape)
```
Por otra parte como métrica para distinguir entre pacientes con una enfermedad más o menos agresiva, el *KLK3* de forma global presenta un rendimiento peor que un clasificador aleatorio.

```{r Métricas KLK3 estratificación de riesgo}
inner_join(
    metric_prognostic_fpr$data %>% filter(identifier == "ENSG00000142515") %>% select(-curve_shape),
    metric_prognostic_tpr$data %>% filter(identifier == "ENSG00000142515") %>% select(-curve_shape),
    join_by(identifier, auc),
    suffix = c("_spec", "_sens")
)
```
```{r ROC KLK3 estratificación de riesgo}
plot_roc_curve(
    prognostic_dataset %>% mutate(prognostic = disease$prognostic),
    response = prognostic,
    predictor = ENSG00000142515
) +
    add_chance_line()
```

La curva $ROC$ del predictor se muestra por debajo de la línea del azar, confirmando ese rendimiento peor que un clasificador completamente aleatorio. El cálculo de la curva se ha realizado considerando la condición de interés de padecer una forma de la enfermedad más agresiva, de esta forma puede explicarse que el *KLK3* rinda mejor identificando formas de la enfermedad menos agresivas.

```{r Inversión de la curva ROC de KLK3 en estratificación de riesgo, warning=FALSE}

inverse_prognostic_dataset <- prognostic_dataset %>%
    mutate(
        prognostic = disease$prognostic
    )

inverse_prognostic_dataset$prognostic <- fct_recode(
    inverse_prognostic_dataset$prognostic,
    "1" = "0",
    "0" = "1"
)

inverse_prognostic_dataset$prognostic <- fct_relevel(
    inverse_prognostic_dataset$prognostic,
    "0"
)

tpr_metrics <- summarize_predictor(
    inverse_prognostic_dataset,
    predictor = ENSG00000142515,
    response = prognostic,
    ratio = "tpr",
    threshold = 0.9
)
fpr_metrics <- summarize_predictor(
    inverse_prognostic_dataset,
    predictor = ENSG00000142515,
    response = prognostic,
    ratio = "fpr",
    threshold = 0.1
)


inner_join(
    fpr_metrics,
    tpr_metrics,
    join_by(auc),
    suffix = c("_spec", "_sens")
) %>%
    mutate(
        identifier = "ENSG00000142515",
        .before = 1
    ) %>%
    select(
        !starts_with("curve_shape")
    )
```
```{r ROC inversa de KLK3}
plot_roc_curve(
    inverse_prognostic_dataset,
    response = prognostic,
    predictor = ENSG00000142515
) +
    add_chance_line()
```

Invirtiendo la curva, las diversas métricas presentan cierta mejora a excepción del $TpAUC$, pero en cualquier caso, estas distan de ser ideales en el ámbito clínico.

Para realizar un mejor contraste de las métricas obtenidas podemos tomar como referencias predictores utilizados en test de evaluación de riesgos ya [utilizados](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9201356/) como por ejemplo: [Decipher](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3691249/) y [Oncotype](https://pubmed.ncbi.nlm.nih.gov/24836057/).

```{r Identificadores de marcadores en tests Decipher y Oncotype}
decipher <- tibble::tribble(
    ~name, ~ensemble,
    "LASP1", "ENSG00000002834",
    "IQGAP3", "ENSG00000183856",
    "NFIB", "ENSG00000147862",
    "S1PR4", "ENSG00000125910",
    "THBS2", "ENSG00000186340",
    "ANO7", "ENSG00000146205",
    "PCDH7", "ENSG00000169851",
    "MYBPC1", "ENSG00000196091",
    "EPPK1", "ENSG00000261150",
    "PBX1", "ENSG00000185630",
    "NUSAP1", "ENSG00000137804",
    "ZWILCH", "ENSG00000174442",
    "UBE2C", "ENSG00000175063",
    "CAMK2N1", "ENSG00000162545",
    "RABGAP1", "ENSG00000011454",
    "TNFRSF19", "ENSG00000127863"
)

oncotype <- tibble::tribble(
    ~name, ~ensemble,
    "BGN", "ENSG00000182492",
    "COL1A1", "ENSG00000108821",
    "SFRP4", "ENSG00000106483",
    "FLNC", "ENSG00000128591",
    "GSN", "ENSG00000148180",
    "TPM2", "ENSG00000198467",
    "GSTM2", "ENSG00000213366",
    "TPX2", "ENSG00000088325",
    "LAMB3", "ENSG00000196878",
    "FAM13C", "ENSG00000148541",
    "KLK2", "ENSG00000167751",
    "AZGP1", "ENSG00000160862",
    "SRD5A2", "ENSG00000277893",
    "DUSP1", "ENSG00000120129",
    "FOS", "ENSG00000170345"
)

metric_prognostic_tpr$data %>%
    arrange(desc(fp_auc)) %>%
    filter(
        identifier %in% oncotype$ensemble |
        identifier %in% decipher$ensemble
    )
```
Entre los datos podemos encontrar algunos de los marcadores utilizados en estos tests, los cuales presentan puntuaciones relativamente bajas a execepción del $FpAUC$ que las puntua en mejor medida. Contrastando los resultados, se puede observar como el $FpAUC$ es más representativo de los marcadores actualmente utilizados en tests de evaluación de riesgos.

Por otra parte algo similar sucede con los predictores `ENSG00000205364` (MTM1) y `ENSG00000187193` (MT1X), los predictores con mayor $FpAUC$, genes que se encuentran relacionados con [actividad supresora de tumores](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4080639/) y con [estados avanzados de la enfermedad](https://pubmed.ncbi.nlm.nih.gov/10754528/).

# 7. Discusión y conclusiones

El desarrollo de nuevas tecnologías permite el análisis de un gran número de marcadores simultáneamente, donde análisis basados en $AUC$ son utilizados habitualmente. En el ámbito clínico regiones concretas de la curva son más relevantes para tratar con los costes de diagnósticos erróneos. Así, las métricas que evaluan estas regiones, como el $pAUC$, están ganando mayor interés. A pesar de ello esta métrica presenta limitaciones para su uso debido a su interpretabilidad, por lo que transformaciones alternativas para trabajar en regiones concretas de la curva resultan de mayor utilidad.

La principal contribución de este trabajo es analizar el rendimiento de las distintas métricas derivadas del $pAUC$ en regiones de interés. Utilizando un conjunto de datos generado con distintas muestras de cáncer de prostata, las métricas han sido evaluadas con respecto a su capacidad para encontrar marcadores de diagnóstico y estratificación de riesgos, escenarios donde condiciones de alta especificidad y sensibilidad son requeridas.

El $SpAUC$ fue la primera transformación del $pAUC$ para trabajar en regiones de alta especificidad. Aunque la métrica presenta una mejor interpretabilidad al comprender sus valores entre $0.5$ y $1$, no es aplicable a regiones de la curva que pasan por debajo de la línea de azar. Estas regiones son comunes en la práctica, lo cual limita su uso. Este problema es resulto por el $TpAUC$, la cual además de tomar valores entre $0.5$ y $1$, puede aplicarse a regiones que pasen por debajo de la línea de azar.

De forma similar para trabajar en regiones de alta sensibilidad se propuso el $NpAUC$. Aunque la métrica pueda tomar como máximo valores de $1$, no se encuentra limitada por debajo, pudiendo tomar valores inferiores a $0.5$ con predictores que presentan curvas con ciertas formas, lo cual dificulta su interpretación y aplicación a ciertos predictores. Estos problemas son resueltos por el $FpAUC$, el cual además de contener sus valores entre $0.5$ y $1$ se puede aplicar independientemente de la forma de la curva en la región de interés.

Además de presentar una mejor interpretabilidad, el $TpAUC$ y $FpAUC$ han sido capaces de distinguir entre predictores que presentan el mismo $pAUC$ y cuyas curvas $ROC$ se cruzan, algo que hasta ahora no había sido posible con las anteriores métricas. Esto supone que tanto el $TpAUC$ y $FpAUC$ poseen una mayor capacidad de discriminación en estos casos, permitiendo la selección de marcadores que convencionalmente se habrían descartado y viceversa.

Finalmente para considerar la relevancia clínica de las métricas, los resultados de cada métrica en el conjunto de datos han sido contrastados con predictores relevantes en el ámbito clínico. Con respecto a marcadores de diagnóstico, el $TpAUC$ otorga puntuaciones similares a los 2 marcadores que presentan mayor interés actualmente, a diferencia del $SpAUC$ que penaliza a uno de ellos.

Por otra parte en codiciones de estratificación de riesgo, el $NpAUC$ presenta valores muy bajos para predictores presentes en el conjunto de datos y que actualmente se utilizan en tests de estratificación de riesgos, a diferencia del $FpAUC$ que les otorga puntuaciones mayores.

Estos resultados, revelan la utilidad práctica que presentan métricas como el $TpAUC$ y $FpAUC$ frente al resto. Su facilidad para ser interpretadas y para discriminar entre marcadores altamente específicos o sensibles incentiva su uso en el ámbito clínico para la selección de marcadores que puedan ayudar en la toma de decisiones.
